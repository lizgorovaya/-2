<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOOK SHOP</title>
    <link href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/order.css">
</head>
<body>
<div class="container">
    <p>Оформление заказа</p>
    
    <!-- Поля для ввода данных -->
    <input class="name" id="customerName" type="text" placeholder="Введите ваше имя">
    <input class="address" id="customerAddress" type="text" placeholder="Введите адрес доставки">
    <select id="book-title">
        <option value="">Название книги</option>
    </select>
    <input class="delivery" id="deliveryDate" type="date" placeholder="Выберите дату доставки">
    <select id="paymentMethod">
        <option value="">Способ оплаты</option>
        <option value="Наличными">Наличными</option>
        <option value="Картой">Картой</option>
    </select>

    <div id="card-info" style="display: none;">
        <input class="card-field" id="cardNumber" type="text" placeholder="Номер карты">
        <input class="card-field" id="cardHolder" type="text" placeholder="Имя держателя карты">
        <input class="card-field" id="expirationDate" type="text" placeholder="Срок действия (MM/YY)">
        <input class="card-field" id="securityCode" type="text" placeholder="CVC/CVV">
    </div>
    
    <textarea id="comment" placeholder="Комментарии для курьера" required></textarea>
    
    <!-- Вставляем карту Яндекс -->
    <div id="map" style="width: 100%; height: 400px;"></div>
    
    <button id="registerBtn">СОЗДАТЬ</button>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
          <h2>Подтверждение оплаты</h2>
          <p>Книга: <span id="modalBookTitle"></span></p>
          <p>Адрес доставки: <span id="modalAddress"></span></p>
          <p>Сумма к оплате:<span id="modalPrice"></span> BYN</p>
          <button id="confirmPaymentBtn">Подтвердить оплату</button>
        </div>
      </div>
      
</div>

<!-- Добавьте ссылку на API Яндекс.Карт -->
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=19f8f579-92a5-4ac0-ac1c-c93fd667e2a8" type="text/javascript"></script>

<script>
 ymaps.ready(function () {
    // Инициализация карты
    var map = new ymaps.Map("map", {
        center: [53.9006, 27.5590], // Центр карты - Минск
        zoom: 13
    });

    // Создаем метку с возможностью перетаскивания
    var placemark = new ymaps.Placemark([53.9006, 27.5590], {
        balloonContent: 'Перетащите метку для выбора адреса'
    }, {
        draggable: true // Делаем метку перетаскиваемой
    });

    // Добавляем метку на карту
    map.geoObjects.add(placemark);

    // Событие: завершение перетаскивания метки
    placemark.events.add('dragend', function () {
        var coordinates = placemark.geometry.getCoordinates(); // Получаем новые координаты метки
        updateAddressField(coordinates); // Обновляем адресное поле
    });

    // Функция для обновления адреса
    function updateAddressField(coords) {
        ymaps.geocode(coords).then(
            function (res) {
                // Берем первый объект из результата
                var firstGeoObject = res.geoObjects.get(0);

                // Если адрес найден
                if (firstGeoObject) {
                    var address = firstGeoObject.getAddressLine(); // Получаем строку адреса

                    // Обновляем поле ввода
                    var addressField = document.getElementById('customerAddress');
                    addressField.value = address;

                    // Сохраняем координаты для дальнейшего использования
                    addressField.setAttribute('data-latitude', coords[0]);
                    addressField.setAttribute('data-longitude', coords[1]);

                    console.log("Адрес успешно обновлен: " + address);
                } else {
                    console.error("Не удалось определить адрес.");
                    alert("Адрес не найден. Попробуйте выбрать другое место.");
                }
            },
            function (err) {
                console.error("Ошибка геокодирования:", err);
                alert("Ошибка при получении адреса. Проверьте подключение к интернету.");
            }
        );
    }
});


// Обработка кнопки "СОЗДАТЬ"
document.addEventListener('DOMContentLoaded', () => {
    // Получаем элемент <select>
    const bookSelect = document.getElementById('book-title');
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const cardInfoDiv = document.getElementById('card-info');

    paymentMethodSelect.addEventListener('change', function () {
        if (paymentMethodSelect.value === 'Картой') {
            cardInfoDiv.style.display = 'block';
        } else {
            cardInfoDiv.style.display = 'none';
        }
    });

    // Проверяем, что элемент существует
    if (!bookSelect) {
        console.error('Элемент <select id="book-title"> не найден в DOM.');
        return;
    }

    // Загружаем данные книг из API
    fetch('http://localhost:8080/api/books')
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при загрузке данных книг');
            }
            return response.json();
        })
        .then(books => {
            // Проверяем, что API вернул данные
            if (!Array.isArray(books) || books.length === 0) {
                console.warn('Список книг пуст или имеет неправильный формат.');
                return;
            }

            // Добавляем книги в <select>
            books.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id; // Используем ID книги как значение
                option.textContent = book.title; // Используем название книги для отображения
                bookSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Ошибка при загрузке данных книг:', error);
        });
});


document.getElementById('registerBtn').addEventListener('click', () => {
    const customerName = document.getElementById('customerName').value.trim();
    const customerAddress = document.getElementById('customerAddress').value.trim();
    const latitude = document.getElementById('customerAddress').getAttribute('data-latitude');
    const longitude = document.getElementById('customerAddress').getAttribute('data-longitude');
    const bookId = document.getElementById('book-title').value;
    const deliveryDate = document.getElementById('deliveryDate').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const comment = document.getElementById('comment').value.trim();

    if (!customerName || !customerAddress || !bookId || !deliveryDate || !paymentMethod) {
        alert('Пожалуйста, заполните все обязательные поля.');
        return;
    }

    const orderData = {
        customerName: customerName,
        customerAddress: customerAddress,
        longitude: parseFloat(longitude) || null,
        latitude: parseFloat(latitude) || null,
        book: { id: bookId },
        deliveryDate: deliveryDate,
        paymentMethod: paymentMethod === 'Картой' ? 'CARD' : 'CASH',
        comment: comment || 'Без комментариев'
    };

    // Если выбрана карта — показываем модалку
    if (paymentMethod === 'Картой') {
        const cardNumber = document.getElementById('cardNumber').value.trim();
        const cardHolder = document.getElementById('cardHolder').value.trim();
        const expirationDate = document.getElementById('expirationDate').value;
        const securityCode = document.getElementById('securityCode').value.trim();

        // Проверка номера карты (16 цифр с пробелами)
        const cardNumberPattern = /^(\d{4} \d{4} \d{4} \d{4})$/;
        if (!cardNumberPattern.test(cardNumber)) {
            alert('Номер карты должен состоять из 16 цифр, разделенных пробелами.');
            return;
        }

        // Проверка имени держателя карты (только английские буквы и заглавные)
        const cardHolderPattern = /^[A-Z\s]+$/;
        if (!cardHolderPattern.test(cardHolder)) {
            alert('Имя держателя карты должно быть написано только английскими заглавными буквами.');
            return;
        }

        // Проверка срока действия (ММ/ГГ)
        const expirationDatePattern = /^(0[1-9]|1[0-2])\/\d{2}$/;
        if (!expirationDatePattern.test(expirationDate)) {
            alert('Срок действия карты должен быть в формате ММ/ГГ.');
            return;
        }

        // Проверка на наличие CVV
        if (!securityCode || securityCode.length !== 3 || isNaN(securityCode)) {
            alert('Код безопасности (CVV) должен содержать ровно 3 цифры.');
            return;
        }

        // Форматируем номер карты (удаляем пробелы перед отправкой)
        const formattedCardNumber = cardNumber.replace(/\s+/g, '');

        orderData.paymentCard = {
            cardNumber: formattedCardNumber,
            cardHolder: cardHolder,
            expirationDate: expirationDate,
            securityCode: securityCode
        };

        // Загружаем данные о книге и отображаем информацию в модалке
        fetch(`http://localhost:8080/api/books/${bookId}`)
            .then(res => res.json())
            .then(book => {
                console.log('Ответ от API:', book); // Логируем ответ, чтобы понять структуру данных

                const bookTitle = book.title || 'Неизвестно';
                const bookPrice = book.price !== undefined ? book.price : '—'; // Если цена не указана

                document.getElementById('modalBookTitle').textContent = bookTitle;
                document.getElementById('modalAddress').textContent = customerAddress;
                document.getElementById('modalPrice').textContent = bookPrice;

                document.getElementById('paymentModal').style.display = 'flex';

                // При подтверждении оплаты отправляем заказ
                document.getElementById('confirmPaymentBtn').onclick = () => {
                    sendOrder(orderData);
                    document.getElementById('paymentModal').style.display = 'none';
                };
            })
            .catch(error => console.error('Ошибка при получении данных о книге:', error));

    } else {
        // если оплата наличными — сразу отправляем
        sendOrder(orderData);
    }
});

function sendOrder(orderData) {
    fetch('http://localhost:8080/api/orders/create', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer YOUR_JWT_TOKEN',
            'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify(orderData)
    })
    .then(response => {
        if (response.ok) {
            alert('Заказ успешно оформлен!');
            window.location.href = 'catalog.html';
        } else {
            return response.json().then(err => {
                console.error('Ошибка:', err);
                alert('Ошибка при создании заказа.');
            });
        }
    })
    .catch(error => {
        console.error('Ошибка сети:', error);
        alert('Ошибка при отправке.');
    });
}



</script>
